<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>材質 × LOGO 融合問卷</title>

    <!-- SurveyJS CSS：雙 CDN 後備 -->
    <link id="svcss" rel="stylesheet" href="https://unpkg.com/survey-core@1.11.9/modern.min.css"
    onerror="this.href='https://cdn.jsdelivr.net/npm/survey-core@1.11.9/modern.min.css'">

    <!-- Survey Core -->
    <script id="svcore" src="https://unpkg.com/survey-core@1.11.9/survey.core.min.js"
    onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/survey-core@1.11.9/survey.core.min.js'"></script>

    <!-- Survey UI（No-framework UI） -->
    <script id="svui" src="https://unpkg.com/survey-ui@1.11.9/survey-ui.min.js"
    onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/survey-ui@1.11.9/survey-ui.min.js'"></script>

    <script>
    // 若兩個 CDN 都失敗，給出明確提示
    window.addEventListener('error', function (e) {
    if (e.target && e.target.id === 'svui') {
    document.getElementById('surveyContainer').innerHTML =
    '<div style="padding:16px;background:#fde2e2;border:1px solid #f5b5b5;border-radius:8px;color:#b42318">' +
    '⚠ 無法載入 SurveyJS UI。請檢查網路是否封鎖 CDN，或改用其它網路再試。' +
    '</div>';
    }
    }, true);
    </script>

  <style>
    :root { color-scheme: light; }
    html,body { height:100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Noto Sans TC", "Segoe UI", Roboto, Arial, sans-serif;
      background:#f7f7f8; margin:0;
    }
    #wrap { max-width: 1040px; margin: 24px auto; padding: 0 16px; }
    .sv-root-modern {
      background:#fff; border-radius:16px; box-shadow: 0 8px 24px rgba(0,0,0,.08); padding: 24px;
    }
    .intro { margin-bottom: 8px; color:#333; }
    .metaRow { display:flex; gap:16px; margin:12px 0 4px; align-items:center; flex-wrap:wrap; }
    .metaCol { display:flex; flex-direction:column; gap:6px; }
    .metaCol img { width: 220px; height: 220px; object-fit: cover; border-radius:12px; border:1px solid #ddd; }
    .sv-progress__text { font-weight:600; }
    .notice { padding:16px;background:#fff3cd;border:1px solid #ffeeba;border-radius:8px;color:#856404; }
    footer { color:#777; font-size:12px; text-align:center; margin: 16px 0 24px; }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="surveyContainer">載入中…</div>
    <footer>若頁面長時間無法載入，請檢查 <code>data.json</code> 與圖片路徑。</footer>
  </div>

  <script>
  // === 可調整設定 ===
  const STORAGE_KEY     = "hexo-survey-image-study-v1";   // 續填用 localStorage key
  const DATA_URL        = "./data.json";                   // 題庫檔（與 index.html 同資料夾）
  const SUBMIT_ENDPOINT = "";                              // 送出結果的 API（可留空做測試）

  const container = document.getElementById("surveyContainer");

  // 讀 data.json 並建構問卷
  fetch(DATA_URL)
    .then(r => {
      if (!r.ok) throw new Error(`讀取 data.json 失敗：HTTP ${r.status}`);
      return r.json();
    })
    .then(cfg => {
      if (!cfg || !Array.isArray(cfg.cases)) {
        throw new Error("data.json 格式錯誤，缺少 cases 陣列");
      }
      buildSurvey(cfg);
    })
    .catch(err => {
      console.error(err);
      container.innerHTML =
        `<div class="notice">⚠ 無法載入題庫：${String(err.message)}<br>
        請確認 <b>data.json</b> 與 <b>images/</b> 路徑、檔名大小寫。</div>`;
    });

  function buildSurvey(cfg){
    const pages = [];
    cfg.cases.forEach((c, idx) => {
      const htmlIntro =
      `<div class="intro">
        <div>第 ${idx+1} 題｜請綜合考慮 <b>結構</b>（logo 形狀）、<b>顏色</b>（與設計稿一致性）、
        <b>材質</b>（紋理是否自然），選出最適合的一張。</div>
        <div class="metaRow">
          <div class="metaCol">
            <div style="font-size:12px;color:#555;">材質圖</div>
            <img src="${c.material}" alt="material" onerror="this.style.opacity=0.2; this.title='找不到材質圖';"/>
          </div>
          <div class="metaCol">
            <div style="font-size:12px;color:#555;">設計圖</div>
            <img src="${c.logo}" alt="logo" onerror="this.style.opacity=0.2; this.title='找不到設計圖';"/>
          </div>
        </div>
      </div>`;

      // 每題選項先複製一份再隨機
      const choices = shuffle((c.options || []).map(o => ({
        value: o.value, imageLink: o.image, text: o.value // 文字顯示 A~E
      })));

      pages.push({
        name: c.id,
        elements: [
          { type:"html", name:c.id+"_intro", html:htmlIntro },
          {
            type:"imagepicker",
            name:c.id,
            title:"請選擇整體融合最佳的一張",
            isRequired:true,
            imageHeight:220,
            imageWidth:220,
            choicesOrder:"none",  // 我們已自行隨機
            showLabel:true,
            choices
          }
        ]
      });
    });

    const json = {
      title: cfg.title || "材質 × LOGO 融合問卷",
      showProgressBar: "top",
      progressBarType: "questions",
      firstPageIsStarted: false,
      pageNextText: "下一題 ▶",
      pagePrevText: "◀ 上一題",
      completeText: "提交",
      showQuestionNumbers: "off",
      pages
    };

    const survey = new Survey.Model(json);

    // 斷點續填：讀取 / 寫入
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try { survey.data = JSON.parse(saved); } catch(_) {}
    }
    survey.onValueChanged.add(() => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(survey.data));
    });
    survey.onCurrentPageChanged.add(() => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(survey.data));
    });

    // 送出
    survey.onComplete.add(async (sender) => {
      const payload = {
        ts: new Date().toISOString(),
        ua: navigator.userAgent,
        answers: sender.data   // { q001: "C", q002: "A", ... }
      };
      console.log("提交結果", payload);

      if (SUBMIT_ENDPOINT) {
        try {
          await fetch(SUBMIT_ENDPOINT, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
          });
          alert("已提交，感謝你的填答！");
        } catch (e) {
          alert("送出失敗，但你的答案已保存在本機。請稍後再試。");
          console.error(e);
        }
      } else {
        alert("測試模式：結果已在瀏覽器 Console 顯示。設定 SUBMIT_ENDPOINT 可上傳到你的後端。");
      }
      localStorage.removeItem(STORAGE_KEY);
    });

    //Survey.StylesManager.applyTheme("defaultV2");
    Survey.StylesManager.applyTheme("modern");
    container.innerHTML = "";
    survey.render(container);
  }

  // 洗牌
  function shuffle(arr){
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  </script>
</body>
</html>
